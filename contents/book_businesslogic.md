# 도서(Book)서비스 구현
**코드는 아무 예고 없이 언제든 변경될 수 있으니, 실제 코드는 해당 서비스 애플리케이션의 Repository에서 확인하세요.**

Sample에서 보여줄 기능은 아래와 같다.

## 구현기능
  - 입고도서등록,도서등록 
    1. 입고도서등록 : 기증 및 도서제공업체에 의해 도서정보가 등록된다.
    2. 대여도서등록 : 도서가 대여할수 있도록 등록된다. 등록 시 Catagory서비스에서 검색되도록 정보전송
    3. 도서상태변경 : 렌탈서비스에서 도서대출시 도서상태 변경기능 '대여가능/대여불가' 
  
  - 도서대여가능여부확인
    1. 렌탈서비스에서 도서대여 가능여부 판단
    
  - 도서 예약
    1. 대출불가 상태에 있는 도서 예약처리


## API설계
주요한 API설계는 다음과 같다.

- 도서정보조회
- 입고도서등록
- 도서등록
- 도서대여가능여부확인
- 도서예약처리

## 인바운드 어댑터


## 도메인 모델링


도서와 입고도서, 도서예약자로 구성된다.
도서공급자나 도서기증에 의해 도서가 입고되면 입고도서 객체가 생성되고 , 이 입고된 도서는 유형에 따라 분류되고 도서관이 지정되어 대여할 수 있는 도서로 등록된다.

대여할수 있게 등록된 객체가 도서이다. 도서는 이용가능을 판단하는 도서상태를 가지고 있어 대여되면 대여불가 상태가되고 반납되면 대여가능상태가 된다.

각 도서는 대여불가시 예약을 할 수 있는데 이를 도서와 도서예약자로 일다다의 관계로 표현하였다.
입고도서와 도서는 엔티티 객체이고, 도서 예약자는 VO객체이다. 
입고도서가 어그리게잇이고, 도서도 역시 어그리게잇이다. 

## 유스케이스 흐름

- 입고도서등록
- 도서등록처리
  
  입고도서등록과 도서등록처리는 프론트에서 받아온 데이터를 등록하는 절차로 특별한 비즈니스 로직은 없다.
  
  도서등록처리는 도서공급자나 도시기증자에 의해 입고된 도서들이 대여할 수 있는 정식도서로 등록되는 절차이다.
  언듯 입고도서객체와 연관관계가 있어 보이나 입고된 도서들을 살펴본 후 하나하나 분류하여 대여할 수 있는 프로세스이기 때문에 백엔드데이터간의 직접적인 연관관계는 없다.
  프론트에서 보여주는 기존 입고도서 정보를 기반으로 도서정보를 수정하여 등록할 수도 있고 , 새로운 도서를 별도로 추가하여 등록할 수도 있다. 
  따라서 다이어그램도 특별한 연관관계를 표시하지 않는다.
  
- 대여가능여부 확인

  대여서비스에 대여시 도서서비스를 동기호출해서 도서대여가능여부를 판단한다는 것 자체가 의존성이 있기 때문에 대여서비스와 도서서비스의 의존성을 일으킨다.
  즉 도서서비스에 장애가 생긴다면 대여기능이 먹통이 될 것이다. 
  이를 위해 서킷브레이크 패턴등을 적용할 수도 있겠지만 이런 동기호출의 의존성을 아예 끊어버릴 수 있다.
  즉 대여시 우선 가대여를 하게 하고 가대여가 되었다는 이벤트를 던진다. 그럼 도서서비스는 대여가능여부를 판단해서 이벤트로 던져준다.
  다음에 대여서비스가 던져준 이벤트 보고 판단하여 대여가능이면 가대여상태를 실대여상태로 변경하고, 대여불가이면 가대여된 것을 취소하는 보상트랜젝션처리를 한다.

  이런식으로 비동기 이벤트 기반으로 변경하면 도서서비스의 의존성 없이 대여서비스가 이루어 질 수 있다. 그렇지만 대여서비스는 시간텀이 존재하는 온라인 배송만 제공하지 않고 오프라인으로 대여가   되어야 하기에 즉시성이 좀더 요구된다. 따라서 본 예에서는 동기호출로 처리하였다. 이렇게 비즈니스에 따라 적절하게 동기 및 비동기 통신매커니즘을 결정할 수 있다.
  
  대여가능여부 메소드는 우선 내부적으로 해당 도서가 대여가능상태인지 파악한다. 대여불가이면 false를 반환하고 , 대여가능상태이면 해당도서에 예약자가 있는지 조사한다.
  예약자가 없으면 true를 반환하고, 예약자가 있다면 해당 사용자가 1순위 대상자인지 확인하여 1순위자면 true를 반환한다.
  
- 도서예약처리 
  대여불가인 상태인 도서를 대여하기 위해서는 예약기능이 필요하다. 
  예약하면 순번이 부여되어 예약자 객체가 해당 도서와 매핑되어 저장된다.
    
## 내부영역 - 도메인 모델 개발
  입고도서 엔티티이다. id, 제목, 설명, 저자, 출판사,IBSN, 출간일 등의 속성등을 가지고 있다.
  
  도서엔티티이다. 도서엔티티는 실제로 대여가능한 도서이기때문에 입고도서가 가진 속성에 추가하여 도서대여상태 및 도서분류 ,보유도서관 등의 속성을 가지고 있다.
  또한 예약자와 일대 다의 관계를 가진다.
  
  주요 기능인 도서대여가능여부확인 및 도서예약에 대한 로직처리를 위해 도서엔티티 메소드를 살펴보자.
  
  도서대여가능여부확인을 위해 3가지 메소드를 제공한다.
  
  
  
  
  예약자는 사용자id와 예약순번의 속성을 가진다.
  표준타입으로 대여가능,불가능의 도서상태를 보유한 BookStatus ENUM 클래스와 도서가 보관된 도서관을 의미하는 Location ENUM 클래스등이 있다.


## 내부영역 - 서비스 개발

어그리게잇 단위로 서비스을 생성하기 때문에  InStockBookService,BookService 인터페이스를 각각 생성한다. 
InStockBookService의 구현체인 InStockBookServiceImpl는 특별한 로직이 없고, 
도서대여가능여부확인 및 도서예약의 책임을 보유한 BookServiceImpl 클래스를 살펴보자. 
도서의 기본로직에게 위임할 것을 제외한 처리들을 진행한다.
위의 유스케이스 흐름에서 짧게 언급한 로직을 상세히 살펴보자.
우선 도서id로 해당도서 객체를 검색하여 가져온다. 처음에는 해당 도서가 대여가능상태인지 파악한다. 
대여불가이면 false를 반환하고 종료한다. 대여가능상태이면 해당도서에 예약자가 있는지 확인한다. 예약자가 없으면 true를 반환하고 종료한다.
예약자가 있다면 해당 사용자가 1순위 대상자인지 확인하여 1순위자면 true를 반환한다. 1순위 대상자가 아니라면 false를 반환한다.


다음은 도서예약이다. 도서예약 메소드는 


## 내부영역 - 레파지토리 개발

## 외부영역 - REST 컨트롤러 개발

## 외부영역 - 아웃바운드 어댑터 개발

## 단위테스트 수행

