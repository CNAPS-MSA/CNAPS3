# 도서(Book)서비스 구현
**코드는 아무 예고 없이 언제든 변경될 수 있으니, 실제 코드는 해당 서비스 애플리케이션의 Repository에서 확인하세요.**

Sample에서 보여줄 기능은 아래와 같다.

## 구현기능
  - 입고도서등록,도서등록 
    1. 입고도서등록 : 기증 및 도서제공업체에 의해 도서정보가 등록된다.
    2. 대여도서등록 : 도서가 대여할수 있도록 등록된다. 등록 시 Catagory서비스에서 검색되도록 정보전송
    3. 도서상태변경 : 렌탈서비스에서 도서대출시 도서상태 변경기능 '대여가능/대여불가' 
    
## API설계
주요한 API설계는 다음과 같다.

- 도서정보조회
- 입고도서등록
- 도서등록


## 도메인 모델링

도서와 입고도서로 구성된다.
도서공급자나 도서기증에 의해 도서가 입고되면 입고도서 객체가 생성되고, 이 입고된 도서는 유형에 따라 분류되고 도서관이 지정되어 대여할 수 있는 도서로 등록된다.

대여할수 있게 등록된 객체가 도서이다. 도서는 이용가능을 판단하는 도서상태를 가지고 있어 대여되면 대여불가 상태가되고 반납되면 대여가능상태가 된다.

입고도서가 어그리게잇이고, 도서도 역시 어그리게잇이다. 

## 유스케이스 흐름

- 입고도서등록
- 도서등록처리
  
  입고도서등록과 도서등록처리는 프론트에서 받아온 데이터를 등록하는 절차로 특별한 비즈니스 로직은 없다.
  
  도서등록처리는 도서공급자나 도시기증자에 의해 입고된 도서들이 대여할 수 있는 정식도서로 등록되는 절차이다.
  언듯 입고도서객체와 연관관계가 있어 보이나 입고된 도서들을 살펴본 후 하나하나 분류하여 대여할 수 있는 프로세스이기 때문에 백엔드데이터간의 직접적인 연관관계는 없다.
  프론트에서 보여주는 기존 입고도서 정보를 기반으로 도서정보를 수정하여 등록할 수도 있고, 새로운 도서를 별도로 추가하여 등록할 수도 있다. 
  따라서 다이어그램도 특별한 연관관계를 표시하지 않는다.
    
## 내부영역 - 도메인 모델 개발
  입고도서 엔티티이다. id, 제목, 설명, 저자, 출판사,IBSN, 출간일 등의 속성등을 가지고 있다.
  
  도서엔티티이다. 도서엔티티는 실제로 대여가능한 도서이기때문에 입고도서가 가진 속성에 추가하여 도서대여상태 및 도서분류, 보유도서관 등의 속성을 가지고 있다.
  
  또한 표준타입으로 대여가능,불가능의 도서상태를 보유한 BookStatus ENUM 클래스와 도서가 보관된 도서관을 의미하는 Location ENUM 클래스등이 있다.


## 내부영역 - 서비스 개발

어그리게잇 단위로 서비스을 생성하기 때문에  InStockBookService, BookService 인터페이스를 각각 생성한다. 

InStockBookService의 구현체인 InStockBookServiceImpl는 특별한 로직이 없고, 
BookService는 Rental Service에서 요청한 도서정보를 반환하는 기능과 도서 정보 업데이트 시 Catalog Service에 이벤트를 전송하는 기능을 담고있다. 


## 내부영역 - 레파지토리 개발

레파지토리는 엔티티당 1개식 만든다.

다음은 BookRepository 인터페이스이다. 

```java
@SuppressWarnings("unused")
@Repository
public interface BookRepository extends JpaRepository<Book, Long> {
}
```
다음은 InStockBookRepository 인터페이스인데 제목으로 도서찾는 기능을 추가했다

```java
@SuppressWarnings("unused")
@Repository
public interface InStockBookRepository extends JpaRepository<InStockBook, Long> {
    Page<InStockBook> findByTitleLike(String title, Pageable pageable);
}
```

## 외부영역 - REST 컨트롤러 개발

프론트에 제공하는 REST API는 다음 기능을 제공해야 한다.  

- 도서정보조회
- 입고도서등록
- 도서등록


## 외부영역 - 아웃바운드 어댑터 개발

도서서비스는 도서가 등록되었을 때, 사용자가 도서를 검색하여 대여할 수 있도록 Catalog서비스에 도서 정보를 전송해야 한다.
따라서, 도서등록 시 비동기 메시지가 카프카로 전송되게 한다.

도서등록 기능이 존재하는 BookServiceImpl서비스에서 도서등록시 처리하도록 구현해 보자.
우선 도메인이벤트를 만들자.


다음은 이 도메인 이벤트를 생성해서 아웃바운드 어댑터를 호출하는 로직이다. 

다음은 아웃바운드 어댑터이다. 카프카로 도메인 이벤트를 보낸다.

## 인바운드 어댑터 개발

도서가 대여/반납되면 Rental 서비스에서 도서가 대여/반납되었다는 비동기 메세지를 발송해 도서 대여 가능상태를 업데이트 시켜야한다. 
따라서, Book 서비스는 도서가 대여/반납되었을 때 발송된 메세지를 수신하여 도서 대여 가능 상태를 업데이트한다.

발송된 비동기 메세지를 수신하는 것은 인바운드 어댑터로 구현한다.

다음은 인바운드 어댑터이다. 

## 단위테스트 수행

마이크로서비스가 분리되어 있기 때문에 동기 및 비동기 테스트는 여러 서비스를 모두 기동하고 수행할 수 밖에 없다. 따라서 이런 테스트는 통합테스트를 통해 수행한다.

서비스를 수행하는 단위테스트는 레이어의 여러 지점에서 수행할 수 있는데 현 시점에서는 서비스가 가진 로직구현을 점검하기 위한 지점인 서비스 인터페이스 앞에서 수행하자. 

다음과 같이 서비스를 테스트하는 Junit 테스트케이스를 생성한다.

여러개의 상태와 예약을 보유한 도서객체 샘플을 생성한다. 
도서대여가능여부확인 및 도서예약처리 기능을 호출하여 의도된 결과가 반환되는 지 체크한다.





