# 마이크로서비스도출하기
- [마이크로서비스도출기법](https://engineering-skcc.github.io/microservice%20modeling/microservice-%EB%8F%84%EC%B6%9C%EA%B8%B0%EB%B2%95/)
- [DDD전략적설계란?](https://engineering-skcc.github.io/microservice%20modeling/ddd-Srategic-design/)
- [마이크로서비스 도출 Easy Method 이벤트스토밍](https://engineering-skcc.github.io/microservice%20modeling/Event-Storming/)
- 마이크로서비스내부구조결정가이드
## 1.마이크로서비스 도출 SAMPLE(도서대여시스템)
사례는 사내 도서대여 시스템(시스템명:티룸)이며 다음과 같은 과정을 거친다. 
## 1.요구사항 
### 1.1 요구사항 
<사용자관리 및 로그인>
- 사용자를 등록한다. 등록 시 사내HR시스템에 검증된다.
- 특정사용자는 사서의 역할을 부여 받는다.
- 사용자는 시스템 사용을 위해 로그인하거나,로 그아웃 할 수 있다.

<도서관리>
- 사서는 도서분류정보를 등록/수정/삭제한다.
- 사서는 입고된 도서를 분류하고 등록/수정/삭제한다.
- 사용자는 도서를 기증할 수 있다.
- 기증 시 10포인트를 부여 받는다.
- 일반적인 도서는 도서공급사에 의해 공급된다.
- 각 도서는 대여할 수 있는 수량(재고)이 있으며 대여/반납에 의해 그 재고가 조정된다.

<도서대출 및 반납>
- 사용자는 도서를 검색한다.
- 사용자는 베스트 대여 목록을 조회할 수 있다.
- 사용자는 재고가 있는 도서를 대여한다.(대여 조건은 2주 1인당 5권이내이다.)
- 대여 불가능한 도서는 예약 할 수 있다.
- 예약자에게는 순번이 부여된다.
- 대여 후 2주가 지나면 시스템은 반납요청메일을 보낸다.
- 사용자는 대여 기간이 2주 한도인 도서를 1주 연장할 수 있다.
- 반납되지 않고 대여 기간이 지난 도서는 연체된다.
- 1권이라도 연체 되면 사용자는 대여 불가 상태가 된다.
- 사용자는 대여한 도서를 반납할 수 있다.
- 대여한 모든 도서 이력은 기록된다.
- 대여, 반납 시 사용자에게 10포인트가 부여된다.
- 연체가 있는 있는 사용자는 대여할 수 없다.(대여불가상태)
- 포인트는 연체 1일당 10포인트씩 연체일을 감면하는데 사용된다.
- 연체일을 0으로 만듦으로써 대여가능상태가 된다.

<배송>
- 원격지의 사용자는 배송을 요청할 수 있다.
- 배송의 상태는 접수/준비/발송/배송완료 이다.
- 배송은 외부배송업체를 이용한다.

<이메일>
- 주요 업무 변화 시 이메일로 사용자에게 통보한다.

## 2.이벤트스토밍를 통한 마이크로서비스 도출
이벤트 스토밍을 통해 비지니스 흐름을 이해하고 마이크로서비스 후보를 식별해 보자. 
위에 요구사항을 사용자관리, 도서관리, 도서대출 및 반납,배송,이메일 등으로 분류하였는데 이것은 비지니스 해결을 위한 문제영역이다. 
도메인 주도설계에서는 문제 영역을 서브 도메인이라 부른다. 서브도메인 별로 이벤트 스토밍을 진행해 보자. 제일 처음은 사용자관리이다.
- 사용자 관리
![image](https://user-images.githubusercontent.com/15258916/87249288-39623800-c499-11ea-98ae-b7dd1b624428.png)
순서는 업무처리 흐름 별로 이벤트(오렌지색)를 모두 붙이고, 이벤트와 대응되는 커맨드(파란색)를 도출하며 액터(작은 노란색)를 통해 도출된 이벤트와 커맨드를 검증한다. 
또한 이벤트와 연관된 외부 인터페이스(보라색)도 식별한다. 그 다음에는 각 이벤트와 커맨드에 영향을 받는 데이터요소인 어그리게잇(노란색)를 찾고 마지막에는 이벤트 발생시 타 영역의 커맨드를 트리거하는 정책(라일락색)를 도출하면 된다.
그럼 위의 사용자 관리 이벤트 스토밍 결과를 살펴보면 [회원 등록됨] 이벤트가 발생되면 레거시 시스템인 HR시스템과 연계되어 [직원여부체크] 정책에서 사원인지를 검증하고 그 여부에 따라  [회원등록 승인됨] 이벤트가 발생되거나 [회원등록 거부됨] 이벤트가 발생한다.  

다음 흐름 순서에 따라  [회원정보 수정됨] 이벤트와 [회원 탈퇴 됨] 이벤트가 발행되고 도서대출, 반납처리에 영향을 받는 회원 별 [포인트 적립, 감소] 이벤트도 발생된다. 
회원이 로그인 하는 과정을 통해 [로그인] , [로그아웃] 이벤트가 발생되고 회원에 의해 [도서 기증됨] 이벤트가 발생될 수 있다.

이벤트도출이 완료되면 이벤트에 매핑 되는 커맨드를 도출하고 커맨드/이벤트에 영향 받는 데이터요소인 [회원], [포인트], [로그인], [도서기증정보]라는 어그리게잇도 식별하였다. 
또한 타 문제 영역의 커맨드를 트리거할 수 있는 정책들도 도출되었는데 이메일을 전송하는 이벤트 및 도서 관리 서브시스템과 연관될 [도서입고처리] 이벤트 이다.

- 도서관리
![image](https://user-images.githubusercontent.com/15258916/87249367-a83f9100-c499-11ea-8a7f-fa21c3ae4e9a.png)
위의 그림은 도서 관리 서브시스템의 이벤트 스토밍 결과이다. 
업무 흐름에 따라 다른 이벤트의 사전 이벤트가 되는 [운영자 등록됨] , [도서 분류 등록됨], [도서관 정보 등록됨] , [도서제공업체 등록됨] 이벤트가 발생되고  
후행으로 [도서 입고됨], [도서 분류됨], [도서 기증 승인됨], [도서 정보 등록됨]의 순서대로 발생된다. 
대여 서브시스템에서 대여/반납이 진행됨에 따라 영향 받는 [재고 변경됨] 이벤트도 발생될 것이며 도서 생명 주기에 따라 [도서 정보 폐기됨] 이벤트도 최종으로 발생된다. 


- 대여
![image](https://user-images.githubusercontent.com/15258916/87249333-74646b80-c499-11ea-87df-a8a5bbca120c.png)
위 그림의 대여 서브시스템이 티움시스템의 가장 복잡한 비지니스 흐름을 가지고 있다. 
살펴보면 도서를 대여하기 위해서는 대여할 도서들을 살펴보아야 한다. [도서 검색됨] 이벤트를 통해 도서가 검색되고 [도서 대출됨] 이벤트를 통해 대출되거나
이미 대출된 도서는 [도서 예약됨] 이벤트에 의해 예약될 수 있다. 먼 곳에 근무하는 경우에는 [배송 요청됨] 이벤트를 통해 근무지로 배송 요청 할 수 있다. 
대출만료기간이 가까이 오면 시스템은 자동으로 대출된 도서를 반납요청하는 메일을 보내는 [반납 요청됨] 이벤트가 발생한다. 
이에 대출자가 도서를 반납하면 [도서 반납됨] 이벤트가 발생되고 반납하지 않고 대여 기간이 지나게 되면 [도서 연체됨] 이벤트가 발생된다. 또는 바로 반납하지 않고 사용자가 대여 기간을 연장하면 [연장 신청됨] 이벤트가 발생할 수도 있다. 

도서가 연체되면 시스템에 의해 [대출 정지됨] 이벤트가 발생하고 정지 해제가 요청되면 [정지 해제됨] 이벤트가 발생된다. 
부가적으로 대출 시 대출 도서를 집계하는  [최다 대여 도서 집계됨] 이라는 이벤트도 발생한다. 그리고 개인별 대출,연체, 반납 내역을 보여주는 개인별 라이브러리를 생성하는 [개인별 라이브러리 생성됨 ] 이벤트도 필요하다. 
액터를 살펴보면 회원, SYS, 대출자, Timer, 연체자등 역할별로 다양한 액터가 도출되었는데 액터의 역할을 세밀하게 구분함으로써 커맨드와 이벤트가 좀더 구체화되거나 새로 식별 될 수 있다.
라일락색의 정책은 내 서브 도메인 내의 다른 커맨드를 트리거 할 수도 있고 밖의 다른 서브 도메인을 커맨드를 트리거 할 수 도 있다. 
이러한 관계가 이 후 식별될 컨텍스트 경계 간의 연관관계를 정의할 수 있게 해준다. 살펴서 구분해 보면 크게 이메일 전송, 포인트 적립, 배송 접수, 도서 재고 증가, 대출 정지 등의 정책들이 도출된 것을 볼 수 있다.
어그리게잇으로는 [최다 대여 도서 집계], [도서검색정보], [대출], [도서 예약], [배송요청정보], [반납], [연장], [연체], [대출가능여부] 등이 도출되었다. 

- 배송
![image](https://user-images.githubusercontent.com/15258916/87249389-cefdc780-c499-11ea-83b6-c2909dba60a5.png)
배송 서브 시스템은 배송 업무 흐름에 따라 [배송업체 등록됨],[배송 접수됨],[배송 준비됨],[배송 발송됨],[배송 완료됨] 이벤트가 발생된다. 이메일 시스템과 연동되고,
배송업체, 배송접수정보, 배송준비정보, 배송발송정보, 배송완료정보라는 어그리게잇이 도출되었다.

- 게시판
![image](https://user-images.githubusercontent.com/15258916/87249418-efc61d00-c499-11ea-858d-90a12d034ae2.png)
기타로 시스템 관련 공지나 질의 사항에 대응하기 위한 게시판 영역에 [게시판 생성됨] , [공지 등록됨], [QnA 등록됨] 이벤트가 도출되었다. 

### 컨텍스트경계(Bounded Context) 도출

그럼 이벤트 스토밍 결과를 보고 경계를 그려 컨텍스트를 구분해 보자. 어그리게잇의 응집도를 살펴 경계를 식별하는 것이 명확하다.
사용자 관리 서브시스템의 어그리게잇을 살펴보면 [운영자정보], [회원], [포인트], [로그인], [도서기증정보]등인데 포인트 및 도서기증정보 등은 회원의 부가 정보로 볼 수 있다. 로그인정보는 회원의 정보도 될 수 있지만 회원이 시스템을 사용하는 시점(로그인상태)의 개념이라는 의미에서 약간의 차별점을 가진다. 또한  회원 가입보다는 로그인이 빈번하게 사용되는 기능이라는 점에서 분리를 고려할 수도 있다. 우선 로그인과 회원으로 컨텍스트 경계를 분리하였다.
게시판, 도서 관리, 배송의 어그리게잇을 살펴보니 특이한 점이 없어 서브시스템이 바로 게시판, 도서, 배송 컨텍스트 경계로 식별되었다.
대여 서브시스템을 살펴보자. 어그리게잇을 살펴보면 [대여 도서 집계 정보], [도서검색정보], [대출], [도서 예약], [배송요청정보], [반납], [연장], [연체], [개인별 라이브러리], [대출가능여부] 등이 식별되었는데 [대출],[반납],[연장],[연체]등의 도서 대여/반납기능에 직접 연관되는 데이터로 대여 컨텍스트를 도출할 수 있다. 
그리고 [도서검색정보], [대여도서집계정보]는 모든 사용자가 대여 전에 접근할 수 있는 정보라는 점에서 개인의 영역인 [도서 예약],[대출],[반납]등의 어그리게잇과는 맥락이 다르다.
 [도서검색정보], [최다 대여 도서 집계] 는 도서 컨텍스트 경계에 좀 더 어울린다. 
 
또한 [도서예약]정보도 개인의 정보이지만 대출 이전의 예약 활동에 대한 정보라는 면에서 대출 컨텍스트에서 분리하여 도서 컨텍스트로 이동하였다.
그런데 도서 컨텍스트로 [도서검색정보], [대여 도서 집계 정보] 어그리게잇을 가져오려 보니 이러한 개념들은 도서원천정보보다 빈번히 일반 회원에게 공개 사용되어야 하는 개념이다.  
그렇다면 조회와 생성, 변경을 분리하는 CQRS패턴을 활용해 보자. 도서컨텍스트와 분리하여 조회를 전담하는 도서검색기능과, 대여도서집계정보기능을 모아 카탈로그 바운디드 컨텍스트를 도출하였다. 
카탈로그 컨텍스트는 도서정보 조회/검색을 위한 역할만 전담하고 도서 컨텍스트의 도서가 변경 시 도메인 이벤트에 의해 그 일관성을 맞춰가야 한다. 
추가로 이메일 처리를 전담할 수 있는 이메일 바운디드 컨텍스트도 도출하였다.
따라서 이렇게 카탈로그, 대여, 도서,배송, 사용자, 로그인,게시판, 이메일등의 8개의 컨텍스트 경계가 식별되었다.
이렇게 컨텍스트 경계가 도출된 다음에 이전에 도출했던, 외부시스템과의 연관관계, 정책등을 살펴보면 컨텍스트 간 호출 관계가 정리된다. 아래 그림은 도출된 컨텍스트와 컨텍스트간의 호출 관계를 식별한 다이어그램이다. 기존 서브시템은 사각형으로 구분되어 있고 서브시스템 과 별도로 식별한 컨텍스트 경계가 타원형 원으로 표시되어 있다. 정책이 가리키는 방향으로 연관관계를 식별하였다.  

![image](https://user-images.githubusercontent.com/15258916/87249526-81358f00-c49a-11ea-81d0-36e54988b046.png)


### 컨텍스트맵(Context Map)
최종으로 다음과 같이 호출 관계를 명확하게 인지할 수 있도록 컨텍스트 다이어그램으로 작성한다.  구체적인 것은 생략하고 식별한 컨텍스트 , 컨텍스트간의 동기 , 비동기 호출 방식만 표현하였다. 점선은 비동기 호출이고, 실선은 동기호출이다. 
이렇게 식별된 컨텍스트가 마이크로서비스 후보가 된다. 이러한 기준으로 마이크로서비스를 설계,개발하도록 하겠다. 서비스는 이후에 배포, 운영 효율성을 고려하여 더 분할되거나 통합될 수 있다. 
![image](https://user-images.githubusercontent.com/15258916/87249562-c6f25780-c49a-11ea-8410-c370251fb965.png)


### 이벤트 스토밍 결과 > 헥사고널 아키텍처로 표현

다음은 이러한 이벤트 스토밍 결과를 상세한 설계로 가져가기 위해 헥사고널 아키텍처로 표현한 것이다. 
이벤트 스토밍 결과는 아래 표와 같이 매핑 되어 이후 API설계,도메인 모델링과 데이터 모델링의 입력물이 된다.

|이벤트스토밍 결과물|헥사고널 아키텍처 구성요소|
|------|------|
|커맨드|외부영역의 인바운드 아댑터 – API 후보|
|어그리게잇|내부영역의 도메인 모델의 후보|
|도메인이벤트|외부영역의 아웃바운드 아댑터로 전송되는 메시지 이벤트 후보|
|외부시스템|외부영역의 아웃바운드 아댑터로 연결될 대외 인터페이스 후보|
|정책|내부영역의 비지니스 로직 규현 규칙
외부영역의 아웃바운드 어댑터로 연결될 타서비스와의 방향 결정에 도움이 됨|

- 헥사고널 접목시킨 컨텍스트 모델
![image](https://user-images.githubusercontent.com/15258916/87249672-55ff6f80-c49b-11ea-9ac0-3b5be1560c14.png)


그림으로 확대해서 살펴보면 아래와 같다. 
어그리게잇은 헥사고널의 내부영역인 도메인모델의 후보가 되고, 커맨드는 외부영역의 인바운드 어댑터인API로 식별된 이벤트는 외부영역의 아웃바운드 어답터로 전송될 메지시 이벤트 대상이 된다.
또 정책의 일부는 내부 비지니스 로직 구현의 규칙으로  또 일부는 타서비스와의 호출 방향을 결정할 자료가 된다. 

- 헥사고널 아키텍처와 이벤트 스토밍
![image](https://user-images.githubusercontent.com/15258916/87249699-8a732b80-c49b-11ea-93f9-205e72b02969.png)











